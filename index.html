<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Pocket++</title>
    <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.5.1.min.js"></script>
    <script src="static/sortable-tables.js" type="text/javascript"></script>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,400;0,500;0,700;1,400;1,700&display=swap" rel="stylesheet"> 
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu Mono:ital,wght@0,400;0,500;0,700;1,400;1,700&display=swap" rel="stylesheet"> 
    <link href="static/style.css" rel="stylesheet">
    <link rel="stylesheet" href="static/sortable-tables.min.css">
</head>
<body>

<script type="text/javascript">
    function zeroPad(x){
        if (x<10) return `0${x}`;
        else return x;
    }

    function fetchArticles(){
        $.get( "articles", function( data ) {
            $("#articlesTable").show();
            for([key, val] of Object.entries(data)) {
                addArticleToTable(val)
            }
            addTableSorting();
        })
    }
    function addArticleToTable(article){
        var dateObject = new Date();
        dateObject.setTime(article.time_added*1000);
        var year = dateObject.getFullYear();
        var month = zeroPad(dateObject.getMonth()+1);
        var day = zeroPad(dateObject.getDate());
        var hour = zeroPad(dateObject.getHours());
        var minutes = zeroPad(dateObject.getMinutes());

        var id=article.item_id;
        var timestamp=article.time_added;
        var added=`${year}-${month}-${day} ${hour}:${minutes}`;
        var words=parseInt(article.word_count);
        var minutes=parseInt(article.time_to_read);
        var title=article.resolved_title;
        var url=`https://app.getpocket.com/read/${id}`;

        if (isNaN(minutes)) minutes=0;
        if (title=='') title="[title unknown]";

        var articleRow=`<tr>`+
            `<td data-sortValue="${timestamp}">${added}</td>`+
            `<td data-sortValue="${words}">${words}</td>`+
            `<td data-sortValue="${minutes}">${minutes}m</td>`+
            `<td><a href='${url}'>${title}</a></td>`+
            `</tr>`;
        
        $("#articlesTable tbody").append(articleRow);
    }

    $(function() {
        $.get( "verify", function( data ) {
            if (data.authenticated==true){
                $("#authenticated").css("color","green")
                $("#authenticated").html("[authenticated]")

                fetchArticles()
            }
            else {
                $("#authenticated").css("color","red")
                $("#authenticated").html("[<a href='login'>please connect to Pocket first</a>]")
            }
        });
    });
</script>

<h1>Pocket++ <span id="authenticated">[status not yet known]</span></h1>

<table id="articlesTable" class="sortable-table">
<thead>
    <tr>
        <th>Date added</th>
        <th class="numeric-sort">Word count</th>
        <th class="numeric-sort">Time to read</th>
        <th>Title</th>
    </tr>
</thead>
<tbody>
    
</tbody>
</table>

</body>
</html>